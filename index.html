<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bing Wallpaper Picker — Smash or Pass</title>
<link rel="preconnect" href="https://bing.npanuhin.me" crossorigin>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  :root { --bg:#0b0d10; --card:#151922; --text:#e8eef9; --sub:#a6b0c3; --accent:#5aa9ff; --ok:#38c172; --no:#e3342f; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:flex;flex-direction:column}
  header{padding:12px 16px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border-bottom:1px solid #1f2430}
  header h1{font-size:16px;margin:0 10px 0 0;white-space:nowrap}
  label{font-size:13px;color:var(--sub)}
  input,select,button{background:#0f131a;color:var(--text);border:1px solid #2a3242;border-radius:8px;padding:8px 10px;font-size:14px}
  button{cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#001225}
  button.good{background:var(--ok);border-color:var(--ok);color:#00150b}
  button.bad{background:var(--no);border-color:var(--no)}
  button:disabled{opacity:.5;cursor:not-allowed}
  #stage{position:relative;flex:1;overflow:hidden;display:grid;place-items:center;padding:10px}
  .card{position:absolute;inset:auto;max-width:min(900px,95vw);max-height:calc(100% - 140px);aspect-ratio:16/9;background:var(--card);border:1px solid #273042;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.5);display:flex;flex-direction:column;overflow:hidden;touch-action:pan-y}
  .card img{width:100%;height:100%;object-fit:cover;flex:1;background:#000}
  .meta{padding:10px 12px;background:rgba(10,12,16,.8);display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
  .meta .title{font-weight:600}
  .meta .date{color:var(--sub);font-size:13px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-left:auto}
  .stackhint{position:absolute;top:10px;left:50%;transform:translateX(-50%);font-size:12px;color:var(--sub)}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid #2a3242}
  #queueInfo{font-size:12px;color:var(--sub)}
  footer{padding:10px 12px;border-top:1px solid #1f2430;display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between}
  .badge{position:absolute;top:14px;font-weight:900;font-size:22px;padding:6px 10px;border-radius:8px;border:3px solid;transform:rotate(-10deg);opacity:0}
  .badge.save{left:14px;color:#d7ffe3;border-color:var(--ok);background:rgba(56,193,114,.12)}
  .badge.pass{right:14px;color:#ffd6d6;border-color:var(--no);background:rgba(227,52,47,.12);transform:rotate(10deg)}
  @media (max-width:640px){ header{gap:6px} .meta{font-size:14px} }
</style>
</head>
<body>
<header>
  <h1>Bing Wallpaper Picker</h1>
  <label>Market
    <input id="market" value="US/en" placeholder="e.g. US/en or ROW/en" />
  </label>
  <label>Year
    <input id="year" type="number" min="2009" max="2100" value="2024" />
  </label>
  <button id="load" class="primary">Load</button>
  <span id="queueInfo" class="pill">0 loaded</span>
  <span class="pill">Keys: ← pass, → save</span>
  <div style="margin-left:auto;display:flex;gap:8px">
    <button id="download" class="good" disabled>Download ZIP (0)</button>
    <button id="clear" class="bad" disabled>Clear Saved</button>
  </div>
</header>

<div id="stage">
  <div class="stackhint">Load a year, then swipe the card. Drag right = save. Drag left = pass.</div>
</div>

<footer>
  <div style="display:flex;gap:8px">
    <button id="passBtn" class="bad" disabled>Pass</button>
    <button id="saveBtn" class="good" disabled>Save</button>
  </div>
  <div style="font-size:12px;color:var(--sub)">Source: bing.npanuhin.me (Bing Wallpaper Archive). Uses the <code>url</code> field returned by the market JSON.</div>
</footer>

<script>
function marketApiURL(market){
  const m = market.trim().replace(/^\/+|\/+$/g,'');
  return [
    `https://cdn.jsdelivr.net/gh/npanuhin/Bing-Wallpaper-Archive@master/api/${m}.json`,
    `https://raw.githubusercontent.com/npanuhin/Bing-Wallpaper-Archive/master/api/${m}.json`,
  ];
}

const state = { items: [], idx: 0, saved: [], preloaded: new Map() };

const stage = document.getElementById('stage');
const loadBtn = document.getElementById('load');
const passBtn = document.getElementById('passBtn');
const saveBtn = document.getElementById('saveBtn');
const dlBtn   = document.getElementById('download');
const clearBtn= document.getElementById('clear');
const queueInfo = document.getElementById('queueInfo');

function fmtDate(s){ try{ return new Date(s).toISOString().slice(0,10) }catch{ return s||'' } }
function updateCounters(){
  queueInfo.textContent = `${state.items.length} loaded · ${state.idx}/${state.items.length} viewed`;
  dlBtn.textContent = `Download ZIP (${state.saved.length})`;
  dlBtn.disabled = state.saved.length===0;
  clearBtn.disabled = state.saved.length===0;
  const canAct = state.items.length>0 && state.idx<state.items.length;
  passBtn.disabled = !canAct; saveBtn.disabled = !canAct;
}

// deeper, smarter preload
async function preload(i){
  const AHEAD = 6;
  for(let k=i; k<i+AHEAD; k++){
    const it = state.items[k];
    if(!it) break;
    if(!state.preloaded.has(it.url)){
      const img = new Image();
      img.decoding = 'async';
      img.referrerPolicy = 'no-referrer';
      img.src = it.url;
      img.decode?.().catch(()=>{});
      state.preloaded.set(it.url,img);
      const l = document.createElement('link'); l.rel='prefetch'; l.href=it.url; document.head.appendChild(l);
    }
  }
}

function makeCard(item){
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <div class="badge save">SAVE</div>
    <div class="badge pass">PASS</div>
    <img alt="" fetchpriority="high" decoding="async" referrerpolicy="no-referrer">
    <div class="meta">
      <div class="title">${escapeHtml(item.title||'(no title)')}</div>
      <div class="date">${fmtDate(item.date)}</div>
      <div class="controls">
        <button class="bad">Pass</button>
        <button class="good">Save</button>
      </div>
    </div>`;
  card.querySelector('img').src = item.url;
  const [bPass,bSave] = card.querySelectorAll('.controls button');
  bPass.onclick = ()=> swipe(card, -1);
  bSave.onclick = ()=> swipe(card, +1);
  enableDrag(card);
  return card;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]))}

/* render current and keep a hidden next ready */
function renderBuffer(i){
  if(!stage.querySelector('.card.current')){
    const c = makeCard(state.items[i]); c.classList.add('current'); stage.appendChild(c);
  }
  if(state.items[i+1] && !stage.querySelector('.card.next')){
    const n = makeCard(state.items[i+1]); n.classList.add('next');
    n.style.opacity=0; n.style.pointerEvents='none'; stage.appendChild(n);
  }
  preload(i);
}

async function loadYear(){
  const y = Number(document.getElementById('year').value);
  const market = document.getElementById('market').value || 'US/en';
  stage.innerHTML = '';
  state.items = []; state.idx = 0; state.preloaded.clear();
  updateCounters();

  const urls = marketApiURL(market);
  let data, lastErr;
  for(const u of urls){
    try{
      const r = await fetch(u, {mode:'cors', cache:'no-cache'});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      data = await r.json(); break;
    }catch(e){ lastErr = e; }
  }
  if(!data){
    stage.innerHTML = `<div class="pill" style="color:#ffb3b3">Load failed for ${urls[0]}. ${lastErr?lastErr.message:''}</div>`;
    return;
  }

  state.items = data.filter(it=>{
    if(!it || !it.url || !it.date) return false;
    return new Date(it.date).getFullYear() === y;
  });

  if(state.items.length===0){
    stage.innerHTML = `<div class="pill">No images found for ${market} ${y}.</div>`;
    updateCounters(); return;
  }

  renderBuffer(0);
  updateCounters();
}

function nextCard(){
  state.idx++;
  updateCounters();

  const cur = stage.querySelector('.card.current');
  if(cur) cur.remove();

  const promoted = stage.querySelector('.card.next');
  if(promoted){
    promoted.classList.remove('next'); promoted.classList.add('current');
    promoted.style.opacity=''; promoted.style.pointerEvents='';
  }

  if(state.items[state.idx+1]){
    const n2 = makeCard(state.items[state.idx+1]);
    n2.classList.add('next'); n2.style.opacity=0; n2.style.pointerEvents='none';
    stage.appendChild(n2);
  }
  preload(state.idx);
}

function swipe(card, dir){
  if(dir>0) card.querySelector('.badge.save').style.opacity = 1;
  else card.querySelector('.badge.pass').style.opacity = 1;

  const off = dir>0 ? stage.clientWidth : -stage.clientWidth;
  card.style.transition = 'transform .25s ease, opacity .25s ease';
  card.style.transform = `translateX(${off}px) rotate(${dir*12}deg)`;
  card.style.opacity = '0.2';

  const current = state.items[state.idx];
  if(dir>0 && current){ state.saved.push(current); dlBtn.textContent = `Download ZIP (${state.saved.length})`; dlBtn.disabled=false; clearBtn.disabled=false; }

  setTimeout(()=>{ nextCard(); }, 240);
}

/* drag / swipe */
function enableDrag(card){
  let startX=0, startY=0, dragging=false;
  const saveBadge = card.querySelector('.badge.save');
