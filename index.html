<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bing Wallpaper Picker — Smash or Pass</title>
<link rel="preconnect" href="https://bing.npanuhin.me" crossorigin>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  :root { --bg:#0b0d10; --card:#151922; --text:#e8eef9; --sub:#a6b0c3; --accent:#5aa9ff; --ok:#38c172; --no:#e3342f; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:flex;flex-direction:column}
  header{padding:12px 16px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border-bottom:1px solid #1f2430}
  header h1{font-size:16px;margin:0 10px 0 0;white-space:nowrap}
  label{font-size:13px;color:var(--sub)}
  input,button{background:#0f131a;color:var(--text);border:1px solid #2a3242;border-radius:8px;padding:8px 10px;font-size:14px}
  button{cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#001225}
  button.good{background:var(--ok);border-color:var(--ok);color:#00150b}
  button.bad{background:var(--no);border-color:var(--no)}
  button:disabled{opacity:.5;cursor:not-allowed}
  #stage{position:relative;flex:1;overflow:hidden;display:grid;place-items:center;padding:10px}
  .card{position:absolute;inset:auto;max-width:min(900px,95vw);max-height:calc(100% - 140px);aspect-ratio:16/9;background:var(--card);border:1px solid #273042;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.5);display:flex;flex-direction:column;overflow:hidden;touch-action:pan-y}
  .card img{width:100%;height:100%;object-fit:cover;flex:1;background:#000}
  .meta{padding:10px 12px;background:rgba(10,12,16,.8);display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
  .meta .title{font-weight:600}
  .meta .date{color:var(--sub);font-size:13px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-left:auto}
  .stackhint{position:absolute;top:10px;left:50%;transform:translateX(-50%);font-size:12px;color:var(--sub)}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid #2a3242}
  #queueInfo{font-size:12px;color:var(--sub)}
  footer{padding:10px 12px;border-top:1px solid #1f2430;display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between}
  .badge{position:absolute;top:14px;font-weight:900;font-size:22px;padding:6px 10px;border-radius:8px;border:3px solid;transform:rotate(-10deg);opacity:0}
  .badge.save{left:14px;color:#d7ffe3;border-color:var(--ok);background:rgba(56,193,114,.12)}
  .badge.pass{right:14px;color:#ffd6d6;border-color:var(--no);background:rgba(227,52,47,.12);transform:rotate(10deg)}
  /* preload overlay */
  #preloadOverlay{position:fixed;inset:0;background:rgba(10,12,16,.92);display:none;align-items:center;justify-content:center;z-index:5}
  #preloadBox{width:min(520px,92vw);background:#131823;border:1px solid #2a3242;border-radius:12px;padding:18px}
  #bar{height:10px;background:#0f131a;border:1px solid #2a3242;border-radius:999px;overflow:hidden;margin-top:10px}
  #bar>i{display:block;height:100%;width:0;background:var(--accent)}
  #pct{font-variant-numeric:tabular-nums}
  @media (max-width:640px){ header{gap:6px} .meta{font-size:14px} }
</style>
</head>
<body>
<header>
  <h1>Bing Wallpaper Picker</h1>
  <label>Market
    <input id="market" value="US/en" placeholder="e.g. US/en or ROW/en" />
  </label>
  <label>Year
    <input id="year" type="number" min="2009" max="2100" value="2024" />
  </label>
  <button id="load" class="primary">Load</button>
  <span id="queueInfo" class="pill">0 loaded</span>
  <span class="pill">Keys: ← pass, → save</span>
  <div style="margin-left:auto;display:flex;gap:8px">
    <button id="download" class="good" disabled>Download ZIP (0)</button>
    <button id="clear" class="bad" disabled>Clear Saved</button>
  </div>
</header>

<div id="stage">
  <div class="stackhint">Load a year. The app will preload all images, then start.</div>
</div>

<footer>
  <div style="display:flex;gap:8px">
    <button id="passBtn" class="bad" disabled>Pass</button>
    <button id="saveBtn" class="good" disabled>Save</button>
  </div>
  <div style="font-size:12px;color:var(--sub)">Source: bing.npanuhin.me (Bing Wallpaper Archive). Uses the <code>url</code> field from the market JSON.</div>
</footer>

<!-- Preload overlay -->
<div id="preloadOverlay">
  <div id="preloadBox">
    <div style="display:flex;justify-content:space-between;align-items:end;gap:8px">
      <div style="font-weight:600">Preloading wallpapers…</div>
      <div id="pct" class="pill">0/0</div>
    </div>
    <div id="bar"><i></i></div>
    <div id="hint" style="margin-top:8px;color:var(--sub);font-size:13px">Decoding images for instant swipes. Please wait.</div>
  </div>
</div>

<script>
/* endpoints */
function marketApiURL(market){
  const m = market.trim().replace(/^\/+|\/+$/g,'');
  return [
    `https://cdn.jsdelivr.net/gh/npanuhin/Bing-Wallpaper-Archive@master/api/${m}.json`,
    `https://raw.githubusercontent.com/npanuhin/Bing-Wallpaper-Archive/master/api/${m}.json`,
  ];
}

/* state */
const state = { items: [], idx: 0, saved: [], preloaded: new Map() };

/* elements */
const stage = document.getElementById('stage');
const loadBtn = document.getElementById('load');
const passBtn = document.getElementById('passBtn');
const saveBtn = document.getElementById('saveBtn');
const dlBtn   = document.getElementById('download');
const clearBtn= document.getElementById('clear');
const queueInfo = document.getElementById('queueInfo');
const overlay = document.getElementById('preloadOverlay');
const pctEl = document.getElementById('pct');
const barEl = document.querySelector('#bar>i');

/* ui helpers */
function fmtDate(s){ try{ return new Date(s).toISOString().slice(0,10) }catch{ return s||'' } }
function updateCounters(){
  queueInfo.textContent = `${state.items.length} loaded · ${state.idx}/${state.items.length} viewed`;
  dlBtn.textContent = `Download ZIP (${state.saved.length})`;
  const any = state.saved.length>0;
  dlBtn.disabled = !any; clearBtn.disabled = !any;
  const canAct = state.items.length>0 && state.idx<state.items.length;
  passBtn.disabled = !canAct; saveBtn.disabled = !canAct;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]))}

/* preload all with concurrency and decode */
async function preloadAll(list, {concurrency=8, onProgress=()=>{}}={}){
  overlay.style.display = 'flex';
  pctEl.textContent = `0/${list.length}`; barEl.style.width = '0%';

  let i = 0, done = 0;
  async function work(idx){
    const it = list[idx]; if(!it) return;
    if(state.preloaded.has(it.url)) { done++; onProgress(done,list.length); return; }
    const img = new Image();
    img.decoding = 'async';
    img.referrerPolicy = 'no-referrer';
    img.src = it.url;
    try{ await img.decode(); }catch{}
    state.preloaded.set(it.url, img);
    done++; onProgress(done, list.length);
  }
  function nextIndex(){ return i < list.length ? i++ : null; }

  const workers = Array.from({length: Math.min(concurrency, list.length)}, async ()=>{
    while(true){ const n = nextIndex(); if(n===null) break; await work(n); }
  });
  await Promise.all(workers);

  overlay.style.display = 'none';
}

/* cards */
function makeCard(item){
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <div class="badge save">SAVE</div>
    <div class="badge pass">PASS</div>
    <img alt="" fetchpriority="high" decoding="async" referrerpolicy="no-referrer">
    <div class="meta">
      <div class="title">${escapeHtml(item.title||'(no title)')}</div>
      <div class="date">${fmtDate(item.date)}</div>
      <div class="controls">
        <button class="bad">Pass</button>
        <button class="good">Save</button>
      </div>
    </div>`;
  const pre = state.preloaded.get(item.url);
  card.querySelector('img').src = pre ? pre.src : item.url;

  const [bPass,bSave] = card.querySelectorAll('.controls button');
  bPass.onclick = ()=> swipe(card, -1);
  bSave.onclick = ()=> swipe(card, +1);
  enableDrag(card);
  return card;
}
function renderBuffer(i){
  if(!stage.querySelector('.card.current')){
    const c = makeCard(state.items[i]); c.classList.add('current'); stage.appendChild(c);
  }
  if(state.items[i+1] && !stage.querySelector('.card.next')){
    const n = makeCard(state.items[i+1]); n.classList.add('next');
    n.style.opacity=0; n.style.pointerEvents='none'; stage.appendChild(n);
  }
}

/* load + full preload */
async function loadYear(){
  const y = Number(document.getElementById('year').value);
  const market = document.getElementById('market').value || 'US/en';
  stage.innerHTML = '';
  state.items = []; state.idx = 0; state.preloaded.clear();
  updateCounters(); loadBtn.disabled = true;

  let data, lastErr;
  for(const u of marketApiURL(market)){
    try{ const r = await fetch(u, {mode:'cors', cache:'no-cache'}); if(!r.ok) throw new Error(`HTTP ${r.status}`); data = await r.json(); break; }
    catch(e){ lastErr = e; }
  }
  if(!data){ stage.innerHTML = `<div class="pill" style="color:#ffb3b3">Load failed. ${lastErr?lastErr.message:''}</div>`; loadBtn.disabled=false; return; }

  state.items = data.filter(it=>it && it.url && it.date && new Date(it.date).getFullYear()===y);
  if(state.items.length===0){ stage.innerHTML = `<div class="pill">No images for ${market} ${y}.</div>`; loadBtn.disabled=false; return; }

  // show progress numbers
  await preloadAll(state.items, {
    concurrency: 8, // adjust if you want slower/faster network load
    onProgress: (done,total)=>{
      pctEl.textContent = `${done}/${total}`;
      barEl.style.width = `${Math.round(done/total*100)}%`;
    }
  });

  renderBuffer(0);
  updateCounters(); loadBtn.disabled=false;
}

/* next / swipe */
function nextCard(){
  state.idx++; updateCounters();
  const cur = stage.querySelector('.card.current'); if(cur) cur.remove();
  const promoted = stage.querySelector('.card.next');
  if(promoted){ promoted.classList.remove('next'); promoted.classList.add('current'); promoted.style.opacity=''; promoted.style.pointerEvents=''; }
  if(state.items[state.idx+1]){
    const n2 = makeCard(state.items[state.idx+1]);
    n2.classList.add('next'); n2.style.opacity=0; n2.style.pointerEvents='none'; stage.appendChild(n2);
  }
}
function swipe(card, dir){
  if(dir>0) card.querySelector('.badge.save').style.opacity = 1;
  else card.querySelector('.badge.pass').style.opacity = 1;
  const off = dir>0 ? stage.clientWidth : -stage.clientWidth;
  card.style.transition = 'transform .25s ease, opacity .25s ease';
  card.style.transform = `translateX(${off}px) rotate(${dir*12}deg)`; card.style.opacity = '0.2';
  const current = state.items[state.idx];
  if(dir>0 && current){ state.saved.push(current); dlBtn.textContent = `Download ZIP (${state.saved.length})`; dlBtn.disabled=false; clearBtn.disabled=false; }
  setTimeout(()=>{ nextCard(); }, 240);
}

/* drag */
function enableDrag(card){
  let startX=0,startY=0,drag=false;
  const saveB = card.querySelector('.badge.save'), passB = card.querySelector('.badge.pass');
  function down(e){ drag=true; startX=e.clientX||e.touches?.[0]?.clientX; startY=e.clientY||e.touches?.[0]?.clientY; card.setPointerCapture?.(e.pointerId) }
  function move(e){ if(!drag) return; const x=(e.clientX||e.touches?.[0]?.clientX)-startX; const y=(e.clientY||e.touches?.[0]?.clientY)-startY;
    card.style.transform=`translate(${x}px,${y}px) rotate(${x/22}deg)`; const a=Math.min(1,Math.abs(x)/120); saveB.style.opacity=x>0?a:0; passB.style.opacity=x<0?a:0; }
  function up(e){ if(!drag) return; drag=false; const rect=stage.getBoundingClientRect(); const x=(e.clientX||e.changedTouches?.[0]?.clientX)-startX;
    if(Math.abs(x)>rect.width*0.22){ swipe(card,x>0?+1:-1); } else { card.style.transition='transform .18s ease'; card.style.transform='translate(0,0) rotate(0)'; saveB.style.opacity=0; passB.style.opacity=0; setTimeout(()=>card.style.transition='',180); } }
  card.addEventListener('pointerdown',down); card.addEventListener('pointermove',move); card.addEventListener('pointerup',up);
  card.addEventListener('touchstart',e=>down(e),{passive:true}); card.addEventListener('touchmove',e=>move(e),{passive:true}); card.addEventListener('touchend',e=>up(e));
}

/* ZIP */
async function downloadZip(){
  if(state.saved.length===0) return;
  const zip = new JSZip(); const folder = zip.folder('bing-selected'); const batch = 6;
  for(let i=0;i<state.saved.length;i+=batch){
    await Promise.all(state.saved.slice(i,i+batch).map(async (item,idx)=>{
      const nameDate = (item.date||'').replaceAll('-',''); const ext=(item.url.split('.').pop()||'jpg').split('?')[0];
      const fname=`${nameDate || String(i+idx).padStart(4,'0')}-${sanitize(item.title||'bing')}.${ext}`;
      try{ const r=await fetch(item.url,{mode:'cors',cache:'no-cache'}); folder.file(fname, await r.blob()); }
      catch{ folder.file(`${fname}.txt`, `Failed to fetch image. Direct link:\n${item.url}`); }
    }));
  }
  const blob = await zip.generateAsync({type:'blob'}); saveAs(blob, `bing-selected-${Date.now()}.zip`);
}
function sanitize(s){ return s.replace(/[\\/:*?"<>|]/g,'').replace(/\s+/g,' ').trim().slice(0,120) }

/* wire */
loadBtn.onclick = loadYear;
passBtn.onclick = ()=>{ const c = stage.querySelector('.card.current'); if(c) swipe(c,-1); };
saveBtn.onclick = ()=>{ const c = stage.querySelector('.card.current'); if(c) swipe(c,+1); };
dlBtn.onclick = downloadZip;
clearBtn.onclick = ()=>{ state.saved.length=0; updateCounters(); };
document.addEventListener('keydown', e=>{ if(passBtn.disabled) return; if(e.key==='ArrowLeft') passBtn.click(); if(e.key==='ArrowRight') saveBtn.click(); });
updateCounters();

/* progress update hook */
(function(){
  const onProgress = (done,total)=>{ pctEl.textContent=`${done}/${total}`; barEl.style.width=`${Math.round(done/total*100)}%`; };
  window.onProgress = onProgress;
})();
</script>
</body>
</html>
