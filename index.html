<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bing Wallpaper Picker — Cached</title>
<link rel="preconnect" href="https://bing.npanuhin.me" crossorigin>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  :root { --bg:#0b0d10; --card:#151922; --text:#e8eef9; --sub:#a6b0c3; --accent:#5aa9ff; --ok:#38c172; --no:#e3342f; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:flex;flex-direction:column}
  header{padding:12px 16px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border-bottom:1px solid #1f2430}
  header h1{font-size:16px;margin:0 10px 0 0;white-space:nowrap}
  label{font-size:13px;color:var(--sub);display:flex;flex-direction:column;gap:4px}
  input,select,button{background:#0f131a;color:var(--text);border:1px solid #2a3242;border-radius:8px;padding:8px 10px;font-size:14px}
  button{cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#001225}
  button.good{background:var(--ok);border-color:var(--ok);color:#00150b}
  button.bad{background:var(--no);border-color:var(--no)}
  button.ghost{background:transparent}
  button:disabled{opacity:.5;cursor:not-allowed}
  #stage{position:relative;flex:1;overflow:hidden;display:grid;place-items:center;padding:10px}
  .card{position:absolute;inset:auto;max-width:min(900px,95vw);max-height:calc(100% - 160px);aspect-ratio:16/9;background:var(--card);border:1px solid #273042;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.5);display:flex;flex-direction:column;overflow:hidden;touch-action:pan-y}
  .imgwrap{position:relative;flex:1;background:#000}
  .imgwrap img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .caption{padding:10px 12px;background:rgba(10,12,16,.88);border-top:1px solid #273042}
  .cap-title{font-weight:600}
  .cap-meta{color:var(--sub);font-size:12px;margin-top:2px}
  .meta{padding:8px 12px;background:rgba(10,12,16,.8);display:flex;gap:8px;align-items:center;flex-wrap:wrap;border-top:1px solid #273042}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-left:auto}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid #2a3242}
  #queueInfo{font-size:12px;color:var(--sub)}
  footer{padding:10px 12px;border-top:1px solid #1f2430;display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between}
  .badge{position:absolute;top:14px;font-weight:900;font-size:22px;padding:6px 10px;border-radius:8px;border:3px solid;transform:rotate(-10deg);opacity:0;z-index:2}
  .badge.save{left:14px;color:#d7ffe3;border-color:var(--ok);background:rgba(56,193,114,.12)}
  .badge.pass{right:14px;color:#ffd6d6;border-color:var(--no);background:rgba(227,52,47,.12);transform:rotate(10deg)}
  /* overlay */
  .overlay{position:fixed;inset:0;background:rgba(10,12,16,.92);display:none;align-items:center;justify-content:center;z-index:5}
  .box{width:min(680px,94vw);max-height:90vh;overflow:auto;background:#131823;border:1px solid #2a3242;border-radius:12px;padding:18px}
  #bar{height:10px;background:#0f131a;border:1px solid #2a3242;border-radius:999px;overflow:hidden;margin-top:10px}
  #bar>i{display:block;height:100%;width:0;background:var(--accent)}
  #pct{font-variant-numeric:tabular-nums}
  /* review modal */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:12px}
  .thumb{position:relative;border:1px solid #2a3242;border-radius:8px;overflow:hidden;background:#000}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .thumb .tag{position:absolute;bottom:6px;left:6px;font-size:11px;padding:2px 6px;border-radius:999px;background:rgba(0,0,0,.55);border:1px solid #2a3242}
  .thumb button{position:absolute;top:6px;right:6px}
  @media (max-width:640px){ header{gap:6px} .caption{font-size:14px} }
</style>
</head>
<body>
<header>
  <h1>Bing Wallpaper Picker</h1>
  <label>Market
    <input id="market" value="US/en" placeholder="US/en or ROW/en" />
  </label>
  <label>Year
    <select id="year"></select>
  </label>
  <button id="load" class="primary">Load</button>
  <span id="queueInfo" class="pill">0 loaded</span>
  <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
    <button id="undo" class="ghost" disabled>Undo</button>
    <button id="review" class="ghost" disabled>Review/Edit</button>
    <button id="download" class="good" disabled>Download ZIP (0)</button>
    <button id="clear" class="bad" disabled>Clear Saved</button>
  </div>
</header>

<div id="stage"><div class="pill">Choose year and Load. Caching continues in background.</div></div>

<footer>
  <div style="display:flex;gap:8px">
    <button id="passBtn" class="bad" disabled>Pass</button>
    <button id="saveBtn" class="good" disabled>Save</button>
  </div>
  <div style="font-size:12px;color:var(--sub)">Captions show title and copyright. Progress is saved locally and resumes after refresh.</div>
</footer>

<!-- Preload/caching overlay -->
<div id="pre" class="overlay">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:end;gap:8px">
      <div style="font-weight:600">Caching wallpapers…</div>
      <div id="pct" class="pill">0/0</div>
    </div>
    <div id="bar"><i></i></div>
    <div id="hint" style="margin-top:8px;color:var(--sub);font-size:13px">
      You can start anytime. Caching continues in the background.
    </div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="startNow" class="primary">Start now</button>
    </div>
  </div>
</div>

<!-- Review/edit modal -->
<div id="rev" class="overlay">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:600">Review selections</div>
      <button id="closeRev">Close</button>
    </div>
    <div style="margin-top:10px">Saved</div>
    <div id="gridSaved" class="grid"></div>
    <div style="margin-top:14px">Skipped</div>
    <div id="gridSkipped" class="grid"></div>
  </div>
</div>

<script>
/* endpoints */
function marketApiURL(market){
  const m = market.trim().replace(/^\/+|\/+$/g,'');
  return [
    `https://cdn.jsdelivr.net/gh/npanuhin/Bing-Wallpaper-Archive@master/api/${m}.json`,
    `https://raw.githubusercontent.com/npanuhin/Bing-Wallpaper-Archive/master/api/${m}.json`,
  ];
}

/* years drop-down 2010..current */
(function initYears(){
  const sel = document.getElementById('year');
  const nowY = new Date().getFullYear();
  for(let y=2010;y<=Math.min(2025, nowY);y++){
    const o=document.createElement('option'); o.value=String(y); o.textContent=String(y);
    if(y===nowY) o.selected=true; sel.appendChild(o);
  }
})();

/* state + persistence */
const state = {
  items: [], idx: 0,
  saved: new Set(), skipped: new Set(),
  history: [], // for undo [{url, action}]
  cacheName: 'bing-wallpapers-v1',
  objUrls: new Map(), // url -> objectURL
  market: 'US/en', year: new Date().getFullYear()
};
const LS_KEY = 'bwp_sessions'; // map { "<market>|<year>": {saved:[url], skipped:[url], idx:n} }

function sessionKey(m,y){ return `${m}|${y}`; }
function loadSession(m,y){
  const raw = localStorage.getItem(LS_KEY); if(!raw) return null;
  try{ const db=JSON.parse(raw)||{}; return db[sessionKey(m,y)]||null; }catch{return null}
}
function saveSession(){
  const raw = localStorage.getItem(LS_KEY); let db={}; try{ db=JSON.parse(raw)||{} }catch{}
  db[sessionKey(state.market,state.year)] = {
    saved: Array.from(state.saved), skipped: Array.from(state.skipped), idx: state.idx
  };
  localStorage.setItem(LS_KEY, JSON.stringify(db));
}

/* els */
const stage = document.getElementById('stage');
const loadBtn = document.getElementById('load');
const passBtn = document.getElementById('passBtn');
const saveBtn = document.getElementById('saveBtn');
const dlBtn = document.getElementById('download');
const clearBtn= document.getElementById('clear');
const queueInfo = document.getElementById('queueInfo');
const undoBtn = document.getElementById('undo');
const reviewBtn = document.getElementById('review');

const overlay = document.getElementById('pre');
const startNowBtn = document.getElementById('startNow');
const pctEl = document.getElementById('pct');
const barEl = document.querySelector('#bar>i');

const rev = document.getElementById('rev');
const closeRevBtn = document.getElementById('closeRev');
const gridSaved = document.getElementById('gridSaved');
const gridSkipped = document.getElementById('gridSkipped');

/* utils */
function fmtDate(s){ try{ return new Date(s).toISOString().slice(0,10) }catch{ return s||'' } }
function esc(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]))}
function sanitize(s){ return s.replace(/[\\/:*?"<>|]/g,'').replace(/\s+/g,' ').trim().slice(0,120) }
function updateCounters(){
  queueInfo.textContent = `${state.items.length} loaded · ${state.idx}/${state.items.length} viewed`;
  dlBtn.textContent = `Download ZIP (${state.saved.size})`;
  const any = state.saved.size>0;
  dlBtn.disabled = !any; clearBtn.disabled = !any;
  const canAct = state.items.length>0 && state.idx<state.items.length;
  passBtn.disabled = !canAct; saveBtn.disabled = !canAct; undoBtn.disabled = state.history.length===0;
  reviewBtn.disabled = state.items.length===0;
}

/* Cache helpers */
async function getFromCache(url){
  const cache = await caches.open(state.cacheName);
  const req = new Request(url, {mode:'no-cors'});
  let resp = await cache.match(req);
  if(!resp){
    const net = await fetch(url, {mode:'cors', cache:'no-cache'});
    const blob = await net.blob();
    resp = new Response(blob, {headers: {'Content-Type': blob.type || 'image/jpeg'}});
    await cache.put(req, resp.clone());
  }
  const blob = await resp.blob();
  let obj = state.objUrls.get(url);
  if(!obj){ obj = URL.createObjectURL(blob); state.objUrls.set(url, obj); }
  return {blob, objURL: obj};
}

/* background caching with progress; can be hidden */
async function cacheAll(){
  overlay.style.display = 'flex';
  const total = state.items.length;
  pctEl.textContent = `0/${total}`; barEl.style.width = '0%';
  let done = 0, i = 0;
  const concurrency = 10;
  async function work(idx){
    const it = state.items[idx]; if(!it) return;
    try{ const {objURL}=await getFromCache(it.url); const im=new Image(); im.decoding='async'; im.src=objURL; try{ await im.decode(); }catch{} }catch{}
    done++; pctEl.textContent=`${done}/${total}`; barEl.style.width = `${Math.round(done/total*100)}%`;
  }
  function nextIndex(){ return i < total ? i++ : null; }
  const workers = Array.from({length: Math.min(concurrency,total)}, async ()=>{
    while(true){ const n = nextIndex(); if(n===null) break; await work(n); }
  });
  Promise.all(workers).finally(()=>{ overlay.style.display='none'; });
}

/* card building (with caption) */
function makeCard(item){
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <div class="badge save">SAVE</div>
    <div class="badge pass">PASS</div>
    <div class="imgwrap"><img alt="" fetchpriority="high" decoding="async" referrerpolicy="no-referrer"></div>
    <div class="caption">
      <div class="cap-title">${esc(item.title||'(no title)')}</div>
      <div class="cap-meta">${fmtDate(item.date)} · ${esc(item.copyright||'© Bing/owners')}</div>
    </div>
    <div class="meta">
      <span class="pill">${state.market}</span>
      <div class="controls">
        <button class="bad">Pass</button>
        <button class="good">Save</button>
      </div>
    </div>`;
  const img = card.querySelector('img');
  const obj = state.objUrls.get(item.url);
  img.src = obj || item.url;

  const [bPass,bSave] = card.querySelectorAll('.controls button');
  bPass.onclick = ()=> swipe(card, -1);
  bSave.onclick = ()=> swipe(card, +1);
  enableDrag(card);
  return card;
}
function renderBuffer(i){
  if(!stage.querySelector('.card.current')){
    const c = makeCard(state.items[i]); c.classList.add('current'); stage.appendChild(c);
  }
  if(state.items[i+1] && !stage.querySelector('.card.next')){
    const n = makeCard(state.items[i+1]); n.classList.add('next'); n.style.opacity=0; n.style.pointerEvents='none'; stage.appendChild(n);
  }
}

/* load year and resume if present */
async function loadYear(){
  state.market = document.getElementById('market').value || 'US/en';
  state.year = Number(document.getElementById('year').value);
  stage.innerHTML = '';
  state.items = []; state.idx = 0; state.saved.clear(); state.skipped.clear(); state.history.length=0;
  updateCounters(); loadBtn.disabled = true;

  let data, lastErr;
  for(const u of marketApiURL(state.market)){
    try{ const r = await fetch(u, {mode:'cors', cache:'no-cache'}); if(!r.ok) throw new Error(`HTTP ${r.status}`); data = await r.json(); break; }
    catch(e){ lastErr = e; }
  }
  if(!data){ stage.innerHTML = `<div class="pill" style="color:#ffb3b3">Load failed. ${lastErr?lastErr.message:''}</div>`; loadBtn.disabled=false; return; }

  state.items = data.filter(it=>it && it.url && it.date && new Date(it.date).getFullYear()===state.year);
  if(state.items.length===0){ stage.innerHTML = `<div class="pill">No images for ${state.market} ${state.year}.</div>`; loadBtn.disabled=false; return; }

  // resume saved session if exists
  const sess = loadSession(state.market, state.year);
  if(sess){
    state.idx = Math.min(sess.idx||0, state.items.length-1);
    for(const u of (sess.saved||[])) state.saved.add(u);
    for(const u of (sess.skipped||[])) state.skipped.add(u);
  }

  // start caching in background and allow immediate start
  await caches.open(state.cacheName);
  cacheAll();
  startNowBtn.onclick = ()=>{ overlay.style.display='none'; if(!stage.querySelector('.card')) startGame(); };
  if(!sess){ overlay.style.display='flex'; } else { // resume immediately
    startGame();
  }
  loadBtn.disabled = false;
}
function startGame(){ stage.innerHTML=''; renderBuffer(state.idx); updateCounters(); saveSession(); }

/* swipe + undo */
function nextCard(){
  state.idx++; updateCounters(); saveSession();
  const cur = stage.querySelector('.card.current'); if(cur) cur.remove();
  const promoted = stage.querySelector('.card.next');
  if(promoted){ promoted.classList.remove('next'); promoted.classList.add('current'); promoted.style.opacity=''; promoted.style.pointerEvents=''; }
  if(state.items[state.idx+1]){
    const n2 = makeCard(state.items[state.idx+1]); n2.classList.add('next'); n2.style.opacity=0; n2.style.pointerEvents='none'; stage.appendChild(n2);
  }
}
function swipe(card, dir){
  const item = state.items[state.idx]; if(!item) return;
  if(dir>0){ state.saved.add(item.url); state.skipped.delete(item.url); card.querySelector('.badge.save').style.opacity = 1; state.history.push({url:item.url,action:'save'}); }
  else { state.skipped.add(item.url); state.saved.delete(item.url); card.querySelector('.badge.pass').style.opacity = 1; state.history.push({url:item.url,action:'pass'}); }
  dlBtn.textContent = `Download ZIP (${state.saved.size})`; dlBtn.disabled = state.saved.size===0 ? true : false; clearBtn.disabled = state.saved.size===0;
  setTimeout(()=>{ nextCard(); }, 220);
  updateCounters();
}
undoBtn.onclick = ()=>{
  const last = state.history.pop(); if(!last) return;
  // move idx back one card if we can
  state.idx = Math.max(0, state.idx-1);
  if(last.action==='save'){ state.saved.delete(last.url); }
  else { state.skipped.delete(last.url); }
  saveSession();
  // rebuild current/next cards
  stage.innerHTML=''; renderBuffer(state.idx); updateCounters();
};

/* review/edit modal */
reviewBtn.onclick = ()=>{ buildReview(); rev.style.display='flex'; };
closeRevBtn.onclick = ()=>{ rev.style.display='none'; saveSession(); updateCounters(); };

function buildReview(){
  gridSaved.innerHTML=''; gridSkipped.innerHTML='';
  const mk = (url, where)=>{
    const it = state.items.find(x=>x.url===url); const wrap=document.createElement('div');
    wrap.className='thumb';
    const img=document.createElement('img'); img.src = state.objUrls.get(url) || url; wrap.appendChild(img);
    const tag=document.createElement('div'); tag.className='tag'; tag.textContent = fmtDate(it?.date||''); wrap.appendChild(tag);
    const btn=document.createElement('button'); btn.textContent = where==='saved' ? 'Move to skipped' : 'Move to saved'; wrap.appendChild(btn);
    btn.onclick=()=>{
      if(where==='saved'){ state.saved.delete(url); state.skipped.add(url); }
      else{ state.skipped.delete(url); state.saved.add(url); }
      saveSession(); buildReview();
    };
    return wrap;
  };
  for(const u of Array.from(state.saved)) gridSaved.appendChild(mk(u,'saved'));
  for(const u of Array.from(state.skipped)) gridSkipped.appendChild(mk(u,'skipped'));
}

/* drag */
function enableDrag(card){
  let startX=0,startY=0,drag=false;
  const saveB = card.querySelector('.badge.save'), passB = card.querySelector('.badge.pass');
  function down(e){ drag=true; startX=e.clientX||e.touches?.[0]?.clientX; startY=e.clientY||e.touches?.[0]?.clientY; card.setPointerCapture?.(e.pointerId) }
  function move(e){ if(!drag) return; const x=(e.clientX||e.touches?.[0]?.clientX)-startX; const y=(e.clientY||e.touches?.[0]?.clientY)-startY;
    card.style.transform=`translate(${x}px,${y}px) rotate(${x/22}deg)`; const a=Math.min(1,Math.abs(x)/120); saveB.style.opacity=x>0?a:0; passB.style.opacity=x<0?a:0; }
  function up(e){ if(!drag) return; drag=false; const rect=stage.getBoundingClientRect(); const x=(e.clientX||e.changedTouches?.[0]?.clientX)-startX;
    if(Math.abs(x)>rect.width*0.22){ swipe(card,x>0?+1:-1); } else { card.style.transition='transform .18s ease'; card.style.transform='translate(0,0) rotate(0)'; saveB.style.opacity=0; passB.style.opacity=0; setTimeout(()=>card.style.transition='',180); } }
  card.addEventListener('pointerdown',down); card.addEventListener('pointermove',move); card.addEventListener('pointerup',up);
  card.addEventListener('touchstart',e=>down(e),{passive:true}); card.addEventListener('touchmove',e=>move(e),{passive:true}); card.addEventListener('touchend',e=>up(e));
}

/* ZIP from cache */
async function downloadZip(){
  if(state.saved.size===0) return;
  const zip = new JSZip(); const folder = zip.folder('bing-selected'); const batch=8;
  const sel = state.items.filter(it=>state.saved.has(it.url));
  for(let i=0;i<sel.length;i+=batch){
    await Promise.all(sel.slice(i,i+batch).map(async (item,idx)=>{
      const nameDate = (item.date||'').replaceAll('-',''); const ext=(item.url.split('.').pop()||'jpg').split('?')[0];
      const fname=`${nameDate || String(i+idx).padStart(4,'0')}-${sanitize(item.title||'bing')}.${ext}`;
      try{ const {blob}=await getFromCache(item.url); folder.file(fname, blob); }
      catch{ folder.file(`${fname}.txt`, `Failed to get image. Direct link:\n${item.url}`); }
    }));
  }
  const blob = await zip.generateAsync({type:'blob'}); saveAs(blob, `bing-selected-${state.market.replace('/','-')}-${state.year}.zip`);
}

/* wire */
document.getElementById('passBtn').onclick = ()=>{ const c = stage.querySelector('.card.current'); if(c) swipe(c,-1); };
document.getElementById('saveBtn').onclick = ()=>{ const c = stage.querySelector('.card.current'); if(c) swipe(c,+1); };
document.getElementById('download').onclick = downloadZip;
document.getElementById('clear').onclick = async ()=>{
  state.saved.clear(); saveSession(); updateCounters();
};
document.getElementById('load').onclick = loadYear;
document.addEventListener('keydown', e=>{
  if(passBtn.disabled) return;
  if(e.key==='ArrowLeft') document.getElementById('passBtn').click();
  if(e.key==='ArrowRight') document.getElementById('saveBtn').click();
  if(e.key.toLowerCase()==='z' && (e.ctrlKey||e.metaKey)) undoBtn.click();
});
updateCounters();

/* auto-resume last session if present */
(function autoResume(){
  const raw = localStorage.getItem(LS_KEY); if(!raw) return;
  try{
    const db = JSON.parse(raw)||{}; const keys = Object.keys(db); if(keys.length===0) return;
    const [m,y] = keys[keys.length-1].split('|'); document.getElementById('market').value=m; document.getElementById('year').value=y;
    loadYear();
  }catch{}
})();
</script>
</body>
</html>
