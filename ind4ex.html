<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bing Wallpaper Selector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
            overflow-x: hidden;
        }

        .header {
            padding: 1rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .year-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .year-input {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            text-align: center;
            max-width: 100px;
        }

        .load-btn, .download-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 25px;
            background: #ff6b6b;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .load-btn:hover, .download-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .load-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
        }

        .loading {
            text-align: center;
            font-size: 1.2rem;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
        }

        .image-container {
            position: relative;
            width: 90vw;
            max-width: 400px;
            height: 60vh;
            max-height: 600px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            cursor: grab;
            transition: transform 0.3s ease;
        }

        .image-container:active {
            cursor: grabbing;
        }

        .wallpaper-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            user-select: none;
            -webkit-user-select: none;
        }

        .image-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: white;
            padding: 2rem 1rem 1rem;
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 2rem;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .pass-btn {
            background: #ff4757;
            color: white;
        }

        .pass-btn:hover {
            background: #ff3742;
            transform: scale(1.1);
        }

        .save-btn {
            background: #2ed573;
            color: white;
        }

        .save-btn:hover {
            background: #1dd361;
            transform: scale(1.1);
        }

        .progress {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: #4facfe;
            transition: width 0.3s ease;
            z-index: 1000;
        }

        .gesture-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .show-hint {
            opacity: 1;
        }

        .completed {
            text-align: center;
            padding: 2rem;
        }

        .completed h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .download-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 2rem;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .year-selector {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .stats {
                flex-direction: column;
                gap: 0.5rem;
            }

            .controls {
                gap: 3rem;
            }

            .control-btn {
                width: 70px;
                height: 70px;
                font-size: 1.8rem;
            }

            .image-container {
                width: 95vw;
                height: 55vh;
            }
        }

        .swipe-left {
            animation: swipeLeft 0.3s ease-out forwards;
        }

        .swipe-right {
            animation: swipeRight 0.3s ease-out forwards;
        }

        @keyframes swipeLeft {
            to {
                transform: translateX(-100vw) rotate(-30deg);
                opacity: 0;
            }
        }

        @keyframes swipeRight {
            to {
                transform: translateX(100vw) rotate(30deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="progress" id="progress"></div>
    
    <div class="header">
        <h1>üñºÔ∏è Bing Wallpaper Selector</h1>
        <div class="year-selector">
            <input type="number" class="year-input" id="yearInput" placeholder="2024" min="2015" max="2025">
            <button class="load-btn" id="loadBtn">Load Wallpapers</button>
        </div>
        <div class="stats">
            <span>Saved: <span id="savedCount">0</span></span>
            <span>Remaining: <span id="remainingCount">0</span></span>
            <span>Total: <span id="totalCount">0</span></span>
        </div>
    </div>

    <div class="main-container" id="mainContainer">
        <div class="loading" id="loadingMsg" style="display: none;">Loading wallpapers</div>
        
        <div class="image-container" id="imageContainer" style="display: none;">
            <img class="wallpaper-img" id="wallpaperImg" alt="Bing Wallpaper">
            <div class="image-info" id="imageInfo"></div>
            <div class="gesture-hint" id="gestureHint">
                Swipe left to pass, swipe right to save<br>
                Or use the buttons below
            </div>
        </div>

        <div class="controls" id="controls" style="display: none;">
            <button class="control-btn pass-btn" id="passBtn">‚úñ</button>
            <button class="control-btn save-btn" id="saveBtn">üíæ</button>
        </div>

        <div class="completed" id="completedSection" style="display: none;">
            <h2>üéâ All Done!</h2>
            <p>You've gone through all the wallpapers for this year.</p>
            <div class="download-section">
                <p>Saved <span id="finalSavedCount">0</span> wallpapers</p>
                <button class="download-btn" id="downloadBtn">Download ZIP</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        class WallpaperSelector {
            constructor() {
                this.wallpapers = [];
                this.currentIndex = 0;
                this.savedWallpapers = [];
                this.isLoading = false;
                this.touchStartX = 0;
                this.touchStartY = 0;
                this.isDragging = false;
                
                this.initElements();
                this.setupEventListeners();
                this.showGestureHint();
            }

            initElements() {
                this.yearInput = document.getElementById('yearInput');
                this.loadBtn = document.getElementById('loadBtn');
                this.loadingMsg = document.getElementById('loadingMsg');
                this.imageContainer = document.getElementById('imageContainer');
                this.wallpaperImg = document.getElementById('wallpaperImg');
                this.imageInfo = document.getElementById('imageInfo');
                this.controls = document.getElementById('controls');
                this.passBtn = document.getElementById('passBtn');
                this.saveBtn = document.getElementById('saveBtn');
                this.completedSection = document.getElementById('completedSection');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.progress = document.getElementById('progress');
                this.gestureHint = document.getElementById('gestureHint');
                
                // Stats elements
                this.savedCount = document.getElementById('savedCount');
                this.remainingCount = document.getElementById('remainingCount');
                this.totalCount = document.getElementById('totalCount');
                this.finalSavedCount = document.getElementById('finalSavedCount');

                // Set default year
                this.yearInput.value = new Date().getFullYear();
            }

            setupEventListeners() {
                this.loadBtn.addEventListener('click', () => this.loadWallpapers());
                this.passBtn.addEventListener('click', () => this.passImage());
                this.saveBtn.addEventListener('click', () => this.saveImage());
                this.downloadBtn.addEventListener('click', () => this.downloadZip());

                // Touch/swipe events
                this.imageContainer.addEventListener('touchstart', (e) => this.handleTouchStart(e));
                this.imageContainer.addEventListener('touchmove', (e) => this.handleTouchMove(e));
                this.imageContainer.addEventListener('touchend', (e) => this.handleTouchEnd(e));

                // Mouse events for desktop
                this.imageContainer.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                this.imageContainer.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                this.imageContainer.addEventListener('mouseup', (e) => this.handleMouseUp(e));
                this.imageContainer.addEventListener('mouseleave', (e) => this.handleMouseUp(e));

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (this.currentIndex < this.wallpapers.length) {
                        if (e.key === 'ArrowLeft' || e.key === 'x' || e.key === 'X') {
                            this.passImage();
                        } else if (e.key === 'ArrowRight' || e.key === 's' || e.key === 'S') {
                            this.saveImage();
                        }
                    }
                });

                // Prevent image dragging
                this.wallpaperImg.addEventListener('dragstart', (e) => e.preventDefault());
            }

            showGestureHint() {
                setTimeout(() => {
                    this.gestureHint.classList.add('show-hint');
                    setTimeout(() => {
                        this.gestureHint.classList.remove('show-hint');
                    }, 3000);
                }, 1000);
            }

            async loadWallpapers() {
                const year = parseInt(this.yearInput.value);
                if (!year || year < 2015 || year > 2025) {
                    alert('Please enter a valid year between 2015 and 2025');
                    return;
                }

                this.isLoading = true;
                this.loadBtn.disabled = true;
                this.loadBtn.textContent = 'Loading...';
                this.loadingMsg.style.display = 'block';
                this.hideAllSections();

                try {
                    this.wallpapers = await this.fetchWallpapersForYear(year);
                    this.currentIndex = 0;
                    this.savedWallpapers = [];
                    
                    if (this.wallpapers.length === 0) {
                        alert('No wallpapers found for this year');
                        return;
                    }

                    this.updateStats();
                    this.showCurrentImage();
                    this.loadingMsg.style.display = 'none';
                    this.imageContainer.style.display = 'block';
                    this.controls.style.display = 'flex';
                } catch (error) {
                    console.error('Error loading wallpapers:', error);
                    alert('Failed to load wallpapers. Please try again.');
                } finally {
                    this.isLoading = false;
                    this.loadBtn.disabled = false;
                    this.loadBtn.textContent = 'Load Wallpapers';
                    this.loadingMsg.style.display = 'none';
                }
            }

            async fetchWallpapersForYear(year) {
                const wallpapers = [];
                const startDate = new Date(year, 0, 1);
                const endDate = new Date(year, 11, 31);
                const currentDate = new Date(startDate);

                while (currentDate <= endDate) {
                    try {
                        const dateStr = currentDate.toISOString().split('T')[0].replace(/-/g, '');
                        const response = await fetch(`https://bing.npanuhin.me/US/en.json?date=${dateStr}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.url && data.title) {
                                wallpapers.push({
                                    url: data.url,
                                    title: data.title,
                                    date: new Date(currentDate),
                                    copyright: data.copyright || '',
                                    filename: `${dateStr}_${data.title.replace(/[^a-zA-Z0-9]/g, '_')}.jpg`
                                });
                            }
                        }
                    } catch (error) {
                        console.warn(`Failed to fetch wallpaper for ${currentDate.toISOString().split('T')[0]}:`, error);
                    }
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                    
                    // Update progress
                    const progress = ((currentDate - startDate) / (endDate - startDate)) * 100;
                    this.progress.style.width = `${Math.min(progress, 100)}%`;
                    
                    // Small delay to prevent overwhelming the API
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                this.progress.style.width = '100%';
                setTimeout(() => {
                    this.progress.style.width = '0%';
                }, 500);

                return wallpapers;
            }

            showCurrentImage() {
                if (this.currentIndex >= this.wallpapers.length) {
                    this.showCompleted();
                    return;
                }

                const wallpaper = this.wallpapers[this.currentIndex];
                this.wallpaperImg.src = wallpaper.url;
                this.wallpaperImg.alt = wallpaper.title;
                
                this.imageInfo.innerHTML = `
                    <strong>${wallpaper.title}</strong><br>
                    ${wallpaper.date.toDateString()}<br>
                    ${wallpaper.copyright ? `<small>${wallpaper.copyright}</small>` : ''}
                `;

                this.updateStats();
            }

            updateStats() {
                this.savedCount.textContent = this.savedWallpapers.length;
                this.remainingCount.textContent = this.wallpapers.length - this.currentIndex;
                this.totalCount.textContent = this.wallpapers.length;
            }

            passImage() {
                if (this.currentIndex >= this.wallpapers.length) return;
                this.animateSwipe('left');
            }

            saveImage() {
                if (this.currentIndex >= this.wallpapers.length) return;
                this.savedWallpapers.push(this.wallpapers[this.currentIndex]);
                this.animateSwipe('right');
            }

            animateSwipe(direction) {
                const className = direction === 'left' ? 'swipe-left' : 'swipe-right';
                this.imageContainer.classList.add(className);
                
                setTimeout(() => {
                    this.imageContainer.classList.remove(className);
                    this.currentIndex++;
                    this.showCurrentImage();
                }, 300);
            }

            showCompleted() {
                this.hideAllSections();
                this.completedSection.style.display = 'block';
                this.finalSavedCount.textContent = this.savedWallpapers.length;
            }

            hideAllSections() {
                this.imageContainer.style.display = 'none';
                this.controls.style.display = 'none';
                this.completedSection.style.display = 'none';
            }

            async downloadZip() {
                if (this.savedWallpapers.length === 0) {
                    alert('No wallpapers saved to download!');
                    return;
                }

                this.downloadBtn.disabled = true;
                this.downloadBtn.textContent = 'Preparing Download...';

                try {
                    const zip = new JSZip();
                    let completed = 0;

                    for (const wallpaper of this.savedWallpapers) {
                        try {
                            const response = await fetch(wallpaper.url);
                            const blob = await response.blob();
                            zip.file(wallpaper.filename, blob);
                            completed++;
                            
                            const progress = (completed / this.savedWallpapers.length) * 100;
                            this.downloadBtn.textContent = `Downloading... ${Math.round(progress)}%`;
                        } catch (error) {
                            console.warn(`Failed to download ${wallpaper.title}:`, error);
                        }
                    }

                    this.downloadBtn.textContent = 'Creating ZIP...';
                    const zipBlob = await zip.generateAsync({type: 'blob'});
                    
                    const url = URL.createObjectURL(zipBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bing_wallpapers_${this.yearInput.value}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                } catch (error) {
                    console.error('Error creating zip:', error);
                    alert('Failed to create download. Please try again.');
                } finally {
                    this.downloadBtn.disabled = false;
                    this.downloadBtn.textContent = 'Download ZIP';
                }
            }

            // Touch event handlers
            handleTouchStart(e) {
                this.touchStartX = e.touches[0].clientX;
                this.touchStartY = e.touches[0].clientY;
                this.isDragging = true;
            }

            handleTouchMove(e) {
                if (!this.isDragging) return;
                e.preventDefault();
                
                const deltaX = e.touches[0].clientX - this.touchStartX;
                const deltaY = e.touches[0].clientY - this.touchStartY;
                
                // Only handle horizontal swipes
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                    const rotation = deltaX * 0.1;
                    this.imageContainer.style.transform = `translateX(${deltaX}px) rotate(${rotation}deg)`;
                    this.imageContainer.style.opacity = 1 - Math.abs(deltaX) / 300;
                }
            }

            handleTouchEnd(e) {
                if (!this.isDragging) return;
                this.isDragging = false;
                
                const deltaX = e.changedTouches[0].clientX - this.touchStartX;
                
                this.imageContainer.style.transform = '';
                this.imageContainer.style.opacity = '';
                
                if (Math.abs(deltaX) > 100) {
                    if (deltaX > 0) {
                        this.saveImage();
                    } else {
                        this.passImage();
                    }
                }
            }

            // Mouse event handlers for desktop
            handleMouseDown(e) {
                this.touchStartX = e.clientX;
                this.touchStartY = e.clientY;
                this.isDragging = true;
            }

            handleMouseMove(e) {
                if (!this.isDragging) return;
                
                const deltaX = e.clientX - this.touchStartX;
                const deltaY = e.clientY - this.touchStartY;
                
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                    const rotation = deltaX * 0.1;
                    this.imageContainer.style.transform = `translateX(${deltaX}px) rotate(${rotation}deg)`;
                    this.imageContainer.style.opacity = 1 - Math.abs(deltaX) / 300;
                }
            }

            handleMouseUp(e) {
                if (!this.isDragging) return;
                this.isDragging = false;
                
                const deltaX = e.clientX - this.touchStartX;
                
                this.imageContainer.style.transform = '';
                this.imageContainer.style.opacity = '';
                
                if (Math.abs(deltaX) > 100) {
                    if (deltaX > 0) {
                        this.saveImage();
                    } else {
                        this.passImage();
                    }
                }
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new WallpaperSelector();
        });
    </script>
</body>
</html>
